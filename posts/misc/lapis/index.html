<!doctype html><html lang=en><head><title>lapis.md :: Vim Emacser Personal Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="title: Database Access Database Access Lapis comes with a set of classes and functions for working with PostgreSQL. In the future other databases will be directly supported. In the meantime you&amp;rsquo;re free to use other OpenResty database drivers, you just won&amp;rsquo;t have access to Lapis&amp;rsquo; query API.
Every query is performed asynchronously through the OpenResty cosocket API. A request will yield and resume automatically so there&amp;rsquo;s no need to code with callbacks, queries can be written sequentially as if they were in a synchronous environment."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/misc/lapis/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/assets/green.css><link rel=apple-touch-icon href=/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=/img/favicon/green.png><meta name=twitter:card content="summary"><meta name=twitter:site content="https://twitter.com/linuxing3"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="lapis.md"><meta property="og:description" content="title: Database Access Database Access Lapis comes with a set of classes and functions for working with PostgreSQL. In the future other databases will be directly supported. In the meantime you&amp;rsquo;re free to use other OpenResty database drivers, you just won&amp;rsquo;t have access to Lapis&amp;rsquo; query API.
Every query is performed asynchronously through the OpenResty cosocket API. A request will yield and resume automatically so there&amp;rsquo;s no need to code with callbacks, queries can be written sequentially as if they were in a synchronous environment."><meta property="og:url" content="/posts/misc/lapis/"><meta property="og:site_name" content="Vim Emacser Personal Blog"><meta property="og:image" content="/img/favicon/green.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2018-02-16 14:05:34 -0400 -0400"></head><body class=green><div class="container full"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Terminal</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/journal>Journal</a></li><li><a href=/showcase>Showcase</a></li><div class=spacer></div><ul class=language-selector><ul class=language-selector-current><li>English ▾</li></ul><ul class="language-selector__more hidden"><li><a href=/>English</a></li><li><a href=/zh/>中文</a></li></ul></ul></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/journal>Journal</a></li><li><a href=/showcase>Showcase</a></li><hr><li><a href=/>English</a></li><li><a href=/zh/>中文</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=/posts/misc/lapis/>lapis.md</a></h1><div class=post-meta><span class=post-date>2018-02-16</span></div><div class=post-content><div><h2 id=title-database-access>title: Database Access<a href=#title-database-access class=hanchor arialabel=Anchor>&#8983;</a></h2><h1 id=database-access>Database Access<a href=#database-access class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Lapis comes with a set of classes and functions for working with
<a href=http://www.postgresql.org/>PostgreSQL</a>. In the future other databases will be
directly supported. In the meantime you&rsquo;re free to use other OpenResty database
drivers, you just won&rsquo;t have access to Lapis&rsquo; query API.</p><p>Every query is performed asynchronously through the <a href=http://wiki.nginx.org/HttpLuaModule#ngx.socket.tcp>OpenResty cosocket
API</a>. A request will yield
and resume automatically so there&rsquo;s no need to code with callbacks, queries can
be written sequentially as if they were in a synchronous environment. Additionally
connections to the server are automatically pooled for optimal performance.</p><p><a href=https://github.com/leafo/pgmoon><em>pgmoon</em></a> is the driver used in Lapis for
communicating with PostgreSQL. It has the advantage of being able to be used
within OpenResty&rsquo;s cosocket API in addition to on the command line using
LuaSocket&rsquo;s synchronous API.</p><h2 id=establishing-a-connection>Establishing A Connection<a href=#establishing-a-connection class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The first step is to define the configuration for our server in the <code>postgres</code>
block in our <code>config.moon</code><code>config.lua</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- config.lua</span>
</span></span><span style=display:flex><span>config(<span style=color:#e6db74>&#34;development&#34;</span>, {
</span></span><span style=display:flex><span>  postgres <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    backend <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pgmoon&#34;</span>,
</span></span><span style=display:flex><span>    host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>,
</span></span><span style=display:flex><span>    user <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pg_user&#34;</span>,
</span></span><span style=display:flex><span>    password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;the_password&#34;</span>,
</span></span><span style=display:flex><span>    database <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;my_database&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>-- config.moon
config &#34;development&#34;, -&gt;
  postgres -&gt;
    backend &#34;pgmoon&#34;
    host &#34;127.0.0.1&#34;
    user &#34;pg_user&#34;
    password &#34;the_password&#34;
    database &#34;my_database&#34;
</code></pre><p><code>host</code> defaults to <code>127.0.0.1</code> and <code>user</code> defaults to <code>postgres</code>, so you can
leave those fields out if they aren&rsquo;t different from the defaults. If a
non-default port is required it can be appended to the <code>host</code> with colon
syntax: <code>my_host:1234</code> (Otherwise <code>5432</code>, the PostgreSQL default, is used).</p><p>You&rsquo;re now ready to start making queries.</p><h2 id=making-a-query>Making a Query<a href=#making-a-query class=hanchor arialabel=Anchor>&#8983;</a></h2><p>There are two ways to make queries:</p><ol><li>The raw query interface is a collection of functions to help you write SQL.</li><li>The <a href=#models><code>Model</code> class</a> is a wrapper around a Lua table that helps you synchronize it with a row in a database table.</li></ol><p>The <code>Model</code> class is the preferred way to interact with the database. The raw
query interface is for achieving things the <code>Model</code> class in unable to do
easily.</p><p>Here&rsquo;s an example of the raw query interface:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> lapis <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;lapis&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> db <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;lapis.db&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> app <span style=color:#f92672>=</span> lapis.Application()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app:match(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> res <span style=color:#f92672>=</span> db.query(<span style=color:#e6db74>&#34;select * from my_table where id = ?&#34;</span>, <span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;ok!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>lapis = require &#34;lapis&#34;
db = require &#34;lapis.db&#34;

class extends lapis.Application
  &#34;/&#34;: =&gt;
    res = db.query &#34;select * from my_table where id = ?&#34;, 10
    &#34;ok!&#34;
</code></pre><p>And the same query represented with the <code>Model</code> class:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> lapis <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;lapis&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> Model <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;lapis.db.model&#34;</span>).Model
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> app <span style=color:#f92672>=</span> lapis.Application()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> MyTable <span style=color:#f92672>=</span> Model:extend(<span style=color:#e6db74>&#34;my_table&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app:match(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> row <span style=color:#f92672>=</span> MyTable:find(<span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;ok!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>lapis = require &#34;lapis&#34;
import Model from require &#34;lapis.db.model&#34;

class MyTable extends Model

class extends lapis.Application
  &#34;/&#34;: =&gt;
    &lt;!r
    --row = MyTable\find 10--&gt;
    &#34;ok!&#34;
</code></pre><p>By default all queries will log to the Nginx notice log. You&rsquo;ll be able to see
each query as it happens.</p><h2 id=query-interface>Query Interface<a href=#query-interface class=hanchor arialabel=Anchor>&#8983;</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> db <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;lapis.db&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>db = require &#34;lapis.db&#34;
</code></pre><p>The <code>db</code> module provides the following functions:</p><h3 id=queryquery-params><code>query(query, params...)</code><a href=#queryquery-params class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Performs a raw query. Returns the result set if successful, returns <code>nil</code> if
failed.</p><p>The first argument is the query to perform. If the query contains any <code>?</code>s then
they are replaced in the order they appear with the remaining arguments. The
remaining arguments are escaped with <code>escape_literal</code> before being
interpolated, making SQL injection impossible.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> res
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>res <span style=color:#f92672>=</span> db.query(<span style=color:#e6db74>&#34;SELECT * FROM hello&#34;</span>)
</span></span><span style=display:flex><span>res <span style=color:#f92672>=</span> db.query(<span style=color:#e6db74>&#34;UPDATE things SET color = ?&#34;</span>, <span style=color:#e6db74>&#34;blue&#34;</span>)
</span></span><span style=display:flex><span>res <span style=color:#f92672>=</span> db.query(<span style=color:#e6db74>&#34;INSERT INTO cats (age, name, alive) VALUES (?, ?, ?)&#34;</span>, <span style=color:#ae81ff>25</span>, <span style=color:#e6db74>&#34;dogman&#34;</span>, <span style=color:#66d9ef>true</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>res = db.query &#34;SELECT * FROM hello&#34;
res = db.query &#34;UPDATE things SET color = ?&#34;, &#34;blue&#34;
res = db.query &#34;INSERT INTO cats (age, name, alive) VALUES (?, ?, ?)&#34;, 25, &#34;dogman&#34;, true
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> hello
</span></span><span style=display:flex><span><span style=color:#66d9ef>UPDATE</span> things <span style=color:#66d9ef>SET</span> color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;blue&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> cats (age, name, alive) <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>25</span>, <span style=color:#e6db74>&#39;dogman&#39;</span>, <span style=color:#66d9ef>TRUE</span>)
</span></span></code></pre></div><p>A query that fails to execute will raise a Lua error. The error will contain
the message from PostgreSQL along with the query.</p><h3 id=selectquery-params><code>select(query, params...)</code><a href=#selectquery-params class=hanchor arialabel=Anchor>&#8983;</a></h3><p>The same as <code>query</code> except it appends <code>"SELECT"</code> to the front of the query.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> res <span style=color:#f92672>=</span> db.select(<span style=color:#e6db74>&#34;* from hello where active = ?&#34;</span>, db.FALSE)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>res = db.select &#34;* from hello where active = ?&#34;, db.FALSE
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> hello <span style=color:#66d9ef>where</span> active <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>
</span></span></code></pre></div><h3 id=inserttable-values-returning><code>insert(table, values, returning...)</code><a href=#inserttable-values-returning class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Inserts a row into <code>table</code>. <code>values</code> is a Lua table of column names and values.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>db.insert(<span style=color:#e6db74>&#34;my_table&#34;</span>, {
</span></span><span style=display:flex><span>  age <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello World&#34;</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>db.insert &#34;my_table&#34;, {
  age: 10
  name: &#34;Hello World&#34;
}
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#e6db74>&#34;my_table&#34;</span> (<span style=color:#e6db74>&#34;age&#34;</span>, <span style=color:#e6db74>&#34;name&#34;</span>) <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>10</span>, <span style=color:#e6db74>&#39;Hello World&#39;</span>)
</span></span></code></pre></div><p>A list of column names to be returned can be given after the value table:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> res <span style=color:#f92672>=</span> db.insert(<span style=color:#e6db74>&#34;some_other_table&#34;</span>, {
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello World&#34;</span>
</span></span><span style=display:flex><span>}, <span style=color:#e6db74>&#34;id&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>res = db.insert &#34;some_other_table&#34;, {
  name: &#34;Hello World&#34;
}, &#34;id&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#e6db74>&#34;some_other_table&#34;</span> (<span style=color:#e6db74>&#34;name&#34;</span>) <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;Hello World&#39;</span>) RETURNING <span style=color:#e6db74>&#34;id&#34;</span>
</span></span></code></pre></div><h3 id=updatetable-values-conditions-params><code>update(table, values, conditions, params...)</code><a href=#updatetable-values-conditions-params class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Updates <code>table</code> with <code>values</code> on all rows that match <code>conditions</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>db.update(<span style=color:#e6db74>&#34;the_table&#34;</span>, {
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Dogbert 2.0&#34;</span>,
</span></span><span style=display:flex><span>  active <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}, {
</span></span><span style=display:flex><span>  id <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>db.update &#34;the_table&#34;, {
  name: &#34;Dogbert 2.0&#34;
  active: true
}, {
  id: 100
}
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>UPDATE</span> <span style=color:#e6db74>&#34;the_table&#34;</span> <span style=color:#66d9ef>SET</span> <span style=color:#e6db74>&#34;name&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Dogbert 2.0&#39;</span>, <span style=color:#e6db74>&#34;active&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#e6db74>&#34;id&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>
</span></span></code></pre></div><p><code>conditions</code> can also be a string, and <code>params</code> will be interpolated into it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>db.update(<span style=color:#e6db74>&#34;the_table&#34;</span>, {
</span></span><span style=display:flex><span>  count <span style=color:#f92672>=</span> db.raw(<span style=color:#e6db74>&#34;count + 1&#34;</span>)
</span></span><span style=display:flex><span>}, <span style=color:#e6db74>&#34;count &lt; ?&#34;</span>, <span style=color:#ae81ff>10</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>db.update &#34;the_table&#34;, {
  count: db.raw&#34;count + 1&#34;
}, &#34;count &lt; ?&#34;, 10
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>UPDATE</span> <span style=color:#e6db74>&#34;the_table&#34;</span> <span style=color:#66d9ef>SET</span> <span style=color:#e6db74>&#34;count&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>count</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>count</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>10</span>
</span></span></code></pre></div><h3 id=deletetable-conditions-params><code>delete(table, conditions, params...)</code><a href=#deletetable-conditions-params class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Deletes rows from <code>table</code> that match <code>conditions</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>db.delete(<span style=color:#e6db74>&#34;cats&#34;</span>, { name: <span style=color:#e6db74>&#34;Roo&#34;</span>})
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>db.delete &#34;cats&#34;, name: &#34;Roo&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>&#34;cats&#34;</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#e6db74>&#34;name&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Roo&#39;</span>
</span></span></code></pre></div><p><code>conditions</code> can also be a string</p><pre tabindex=0><code class=language-moon data-lang=moon>db.delete(&#34;cats&#34;, &#34;name = ?&#34;, &#34;Gato&#34;)
</code></pre><pre tabindex=0><code class=language-moon data-lang=moon>db.delete &#34;cats&#34;, &#34;name = ?&#34;, &#34;Gato&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>&#34;cats&#34;</span> <span style=color:#66d9ef>WHERE</span> name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Gato&#39;</span>
</span></span></code></pre></div><h3 id=rawstr><code>raw(str)</code><a href=#rawstr class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Returns a special value that will be inserted verbatim into the query without being
escaped:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>db.update(<span style=color:#e6db74>&#34;the_table&#34;</span>, {
</span></span><span style=display:flex><span>  count <span style=color:#f92672>=</span> db.raw(<span style=color:#e6db74>&#34;count + 1&#34;</span>)
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>db.select(<span style=color:#e6db74>&#34;* from another_table where x = ?&#34;</span>, db.raw(<span style=color:#e6db74>&#34;now()&#34;</span>))
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>db.update &#34;the_table&#34;, {
  count: db.raw&#34;count + 1&#34;
}

db.select &#34;* from another_table where x = ?&#34;, db.raw&#34;now()&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>UPDATE</span> <span style=color:#e6db74>&#34;the_table&#34;</span> <span style=color:#66d9ef>SET</span> <span style=color:#e6db74>&#34;count&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>count</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> another_table <span style=color:#66d9ef>where</span> x <span style=color:#f92672>=</span> now()
</span></span></code></pre></div><h3 id=escape_literalvalue><code>escape_literal(value)</code><a href=#escape_literalvalue class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Escapes a value for use in a query. A value is any type that can be stored in a
column. Numbers, strings, and booleans will be escaped accordingly.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> escaped <span style=color:#f92672>=</span> db.escape_literal(value)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> res <span style=color:#f92672>=</span> db.query(<span style=color:#e6db74>&#34;select * from hello where id = &#34;</span> <span style=color:#f92672>..</span> escaped<span style=color:#e6db74>&#34;)
</span></span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>escaped = db.escape_literal value
res = db.query &#34;select * from hello where id = #{escaped}&#34;
</code></pre><p><code>escape_literal</code> is not appropriate for escaping column or table names. See
<code>escape_identifier</code>.</p><h3 id=escape_identifierstr><code>escape_identifier(str)</code><a href=#escape_identifierstr class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Escapes a string for use in a query as an identifier. An identifier is a column
or table name.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> table_name <span style=color:#f92672>=</span> db.escape_identifier(<span style=color:#e6db74>&#34;table&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> res <span style=color:#f92672>=</span> db.query(<span style=color:#e6db74>&#34;select * from &#34;</span> <span style=color:#f92672>..</span> table_name)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>table_name = db.escape_identifier &#34;table&#34;
res = db.query &#34;select * from #{table_name}&#34;
</code></pre><p><code>escape_identifier</code> is not appropriate for escaping values. See
<code>escape_literal</code> for escaping values.</p><h3 id=constants>Constants<a href=#constants class=hanchor arialabel=Anchor>&#8983;</a></h3><p>The following constants are also available:</p><ul><li><code>NULL</code> &ndash; represents <code>NULL</code> in SQL</li><li><code>TRUE</code> &ndash; represents <code>TRUE</code> in SQL</li><li><code>FALSE</code> &ndash; represents <code>FALSE</code> in SQL</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>db.update(<span style=color:#e6db74>&#34;the_table&#34;</span>, {
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> db.NULL
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>db.update &#34;the_table&#34;, {
  name: db.NULL
}
</code></pre><h2 id=models>Models<a href=#models class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Lapis provides a <code>Model</code> base class for making Lua tables that can be
synchronized with a database row. The class is used to represent a single
database table, an instance of the class is used to represent a single row of
that table.</p><p>The most primitive model is a blank model:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> Model <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;lapis.db.model&#34;</span>).Model
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> Users <span style=color:#f92672>=</span> Model:extend(<span style=color:#e6db74>&#34;users&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>import Model from require &#34;lapis.db.model&#34;

class Users extends Model
</code></pre><pre tabindex=0><code class=language-moon data-lang=moon>class Users extends Model
  @table_name: =&gt; &#34;active_users&#34;
</code></pre><h3 id=primary-keys>Primary Keys<a href=#primary-keys class=hanchor arialabel=Anchor>&#8983;</a></h3><p>By default all models have the primary key &ldquo;id&rdquo;. This can be changed by setting
the <code>@primary_key</code><code>self.primary_key</code> class variable.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> Users <span style=color:#f92672>=</span> Model:extend(<span style=color:#e6db74>&#34;users&#34;</span>, {
</span></span><span style=display:flex><span>  primary_key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;login&#34;</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>class Users extends Model
  @primary_key: &#34;login&#34;
</code></pre><p>If there are multiple primary keys then an array table can be used:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> Followings <span style=color:#f92672>=</span> Model:extend(<span style=color:#e6db74>&#34;followings&#34;</span>, {
</span></span><span style=display:flex><span>  primary_key <span style=color:#f92672>=</span> { <span style=color:#e6db74>&#34;user_id&#34;</span>, <span style=color:#e6db74>&#34;followed_user_id&#34;</span> }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>class Followings extends Model
  @primary_key: { &#34;user_id&#34;, &#34;followed_user_id&#34; }
</code></pre><h3 id=finding-a-row>Finding a Row<a href=#finding-a-row class=hanchor arialabel=Anchor>&#8983;</a></h3><p>For the following examples assume we have the following models:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> Model <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;lapis.db.model&#34;</span>).Model
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> Users <span style=color:#f92672>=</span> Model:extend(<span style=color:#e6db74>&#34;users&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> Tags <span style=color:#f92672>=</span> Model:extend(<span style=color:#e6db74>&#34;tags&#34;</span>, {
</span></span><span style=display:flex><span>  primary_key <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;user_id&#34;</span>, <span style=color:#e6db74>&#34;tag&#34;</span>}
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>import Model from require &#34;lapis.db.model&#34;

class Users extends Model

class Tags extends Model
  @primary_key: {&#34;user_id&#34;, &#34;tag&#34;}
</code></pre><p>When you want to find a single row the <code>find</code> class method is used. In the
first form it takes a variable number of values, one for each primary key in
the order the primary keys are specified:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> user <span style=color:#f92672>=</span> Users:find(<span style=color:#ae81ff>23232</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> tag <span style=color:#f92672>=</span> Tags:find(<span style=color:#ae81ff>1234</span>, <span style=color:#e6db74>&#34;programmer&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>user = Users\find 23232
tag = Tags\find 1234, &#34;programmer&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;users&#34;</span> <span style=color:#66d9ef>where</span> <span style=color:#e6db74>&#34;id&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>23232</span> <span style=color:#66d9ef>limit</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;tags&#34;</span> <span style=color:#66d9ef>where</span> <span style=color:#e6db74>&#34;user_id&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1234</span> <span style=color:#66d9ef>and</span> <span style=color:#e6db74>&#34;tag&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;programmer&#39;</span> <span style=color:#66d9ef>limit</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p><code>find</code> returns an instance of the model. In the case of the user, if there was a
<code>name</code> column, then we could access the users name with <code>user.name</code>.</p><p>We can also pass a table as an argument to <code>find</code>. The table will be converted
to a <code>WHERE</code> clause in the query:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> user <span style=color:#f92672>=</span> Users:find({ email <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;person@example.com&#34;</span> })
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>user = Users\find email: &#34;person@example.com&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;users&#34;</span> <span style=color:#66d9ef>where</span> <span style=color:#e6db74>&#34;email&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;person@example.com&#39;</span> <span style=color:#66d9ef>limit</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><h3 id=finding-many-rows>Finding Many Rows<a href=#finding-many-rows class=hanchor arialabel=Anchor>&#8983;</a></h3><p>When searching for multiple rows the <code>select</code> class method is used. It works
similarly to the <code>select</code> function from the raw query interface except you
specify the part of the query after the list of columns to select.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> tags <span style=color:#f92672>=</span> Tags:select(<span style=color:#e6db74>&#34;where tag = ?&#34;</span>, <span style=color:#e6db74>&#34;merchant&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>tags = Tags\select &#34;where tag = ?&#34;, &#34;merchant&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;tags&#34;</span> <span style=color:#66d9ef>where</span> tag <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;merchant&#39;</span>
</span></span></code></pre></div><p>Instead of a single instance, an array table of instances is returned.</p><p>If you want to restrict which columns are selected you can pass in a table as
the last argument with the <code>fields</code> key set:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> tags <span style=color:#f92672>=</span> Tags:select(<span style=color:#e6db74>&#34;where tag = ?&#34;</span>, <span style=color:#e6db74>&#34;merchant&#34;</span>, { fields <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;created_at as c&#34;</span> })
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>tags = Tags\select &#34;where tag = ?&#34;, &#34;merchant&#34;, fields: &#34;created_at as c&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> created_at <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>c</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;tags&#34;</span> <span style=color:#66d9ef>where</span> tag <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;merchant&#39;</span>
</span></span></code></pre></div><p>Alternatively if you want to find many rows by their primary key you can use
the <code>find_all</code> method. It takes an array table of primary keys. This method
only works on tables that have singular primary keys.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> users <span style=color:#f92672>=</span> Users:find_all({ <span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>4</span>,<span style=color:#ae81ff>5</span> })
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>users = Users\find_all { 1,2,3,4,5 }
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;users&#34;</span> <span style=color:#66d9ef>where</span> <span style=color:#e6db74>&#34;id&#34;</span> <span style=color:#66d9ef>in</span> (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>)
</span></span></code></pre></div><p>If you need to find many rows for another column other than the primary key you
can pass in the optional second argument:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> users <span style=color:#f92672>=</span> UserProfile:find_all({ <span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>4</span>,<span style=color:#ae81ff>5</span> }, <span style=color:#e6db74>&#34;user_id&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>users = UserProfile\find_all { 1,2,3,4,5 }, &#34;user_id&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;UserProfile&#34;</span> <span style=color:#66d9ef>where</span> <span style=color:#e6db74>&#34;user_id&#34;</span> <span style=color:#66d9ef>in</span> (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>)
</span></span></code></pre></div><p>The second argument can also be a table of options. The following properties
are supported:</p><ul><li><code>key</code> &ndash; Specify the column name to find by, same effect as passing in a string as the second argument</li><li><code>fields</code> &ndash; Comma separated list of column names to fetch instead of the default <code>*</code></li><li><code>where</code> &ndash; A table of additional <code>where</code> clauses for the query</li></ul><p>For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> users <span style=color:#f92672>=</span> UserProfile:find_all({<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>4</span>}, {
</span></span><span style=display:flex><span>  key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;user_id&#34;</span>,
</span></span><span style=display:flex><span>  fields <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;user_id, twitter_account&#34;</span>,
</span></span><span style=display:flex><span>  where <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    public <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>users = UserProfile\find_all {1,2,3,4}, {
  key: &#34;user_id&#34;
  fields: &#34;user_id, twitter_account&#34;
  where: {
    public: true
  }
}
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> user_id, twitter_account <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;things&#34;</span> <span style=color:#66d9ef>where</span> <span style=color:#e6db74>&#34;user_id&#34;</span> <span style=color:#66d9ef>in</span> (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>) <span style=color:#66d9ef>and</span> <span style=color:#e6db74>&#34;public&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>
</span></span></code></pre></div><h3 id=inserting-rows>Inserting Rows<a href=#inserting-rows class=hanchor arialabel=Anchor>&#8983;</a></h3><p>The <code>create</code> class method is used to create new rows. It takes a table of
column values to create the row with. It returns an instance of the model. The
create query fetches the values of the primary keys and sets them on the
instance using the PostgreSQL <code>RETURN</code> statement. This is useful for getting
the value of an auto-incrementing key from the insert statement.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> user <span style=color:#f92672>=</span> Users:create({
</span></span><span style=display:flex><span>  login <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;superuser&#34;</span>,
</span></span><span style=display:flex><span>  password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1234&#34;</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>user = Users\create {
  login: &#34;superuser&#34;
  password: &#34;1234&#34;
}
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#e6db74>&#34;users&#34;</span> (<span style=color:#e6db74>&#34;password&#34;</span>, <span style=color:#e6db74>&#34;login&#34;</span>) <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;1234&#39;</span>, <span style=color:#e6db74>&#39;superuser&#39;</span>) RETURNING <span style=color:#e6db74>&#34;id&#34;</span>
</span></span></code></pre></div><h3 id=updating-a-row>Updating a Row<a href=#updating-a-row class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Instances of models have the <code>update</code> method for updating the row. The values
of the primary keys are used to uniquely identify the row for updating.</p><p>The first form of update takes variable arguments. A list of strings that
represent column names to be updated. The values of the columns are taken from
the current values in the instance.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> user <span style=color:#f92672>=</span> Users:find(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>user.login <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;uberuser&#34;</span>
</span></span><span style=display:flex><span>user.email <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;admin@example.com&#34;</span>
</span></span><span style=display:flex><span>user:update(<span style=color:#e6db74>&#34;login&#34;</span>, <span style=color:#e6db74>&#34;email&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>user = Users\find 1
user.login = &#34;uberuser&#34;
user.email = &#34;admin@example.com&#34;

user\update &#34;login&#34;, &#34;email&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>UPDATE</span> <span style=color:#e6db74>&#34;users&#34;</span> <span style=color:#66d9ef>SET</span> <span style=color:#e6db74>&#34;login&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;uberuser&#39;</span>, <span style=color:#e6db74>&#34;email&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;admin@example.com&#39;</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#e6db74>&#34;id&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>Alternatively we can pass a table as the first argument of <code>update</code>. The keys
of the table are the column names, and the values are the values to update the
columns with. The instance is also updated. We can rewrite the above example as:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> user <span style=color:#f92672>=</span> Users:find(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>user:update({
</span></span><span style=display:flex><span>  login <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;uberuser&#34;</span>,
</span></span><span style=display:flex><span>  email <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;admin@example.com&#34;</span>,
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>user = Users\find 1
user\update {
  login: &#34;uberuser&#34;
  email: &#34;admin@example.com&#34;
}
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>UPDATE</span> <span style=color:#e6db74>&#34;users&#34;</span> <span style=color:#66d9ef>SET</span> <span style=color:#e6db74>&#34;login&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;uberuser&#39;</span>, <span style=color:#e6db74>&#34;email&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;admin@example.com&#39;</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#e6db74>&#34;id&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><blockquote><p>The table argument can also take positional values, which are treated the
same as the variable argument form.</p></blockquote><h3 id=deleting-a-row>Deleting a Row<a href=#deleting-a-row class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Just call <code>delete</code> on the instance:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> user <span style=color:#f92672>=</span> Users:find(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>user:delete()
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>user = Users\find 1
user\delete!
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>&#34;users&#34;</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#e6db74>&#34;id&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><h3 id=timestamps>Timestamps<a href=#timestamps class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Because it&rsquo;s common to store creation and update times, models have
support for managing these columns automatically.</p><p>When creating your table make sure your table has the following columns:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> ... (
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;created_at&#34;</span> <span style=color:#66d9ef>timestamp</span> <span style=color:#66d9ef>without</span> time <span style=color:#66d9ef>zone</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;updated_at&#34;</span> <span style=color:#66d9ef>timestamp</span> <span style=color:#66d9ef>without</span> time <span style=color:#66d9ef>zone</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>Then define your model with the <code>@timestamp</code> class
variable<code>timestamp</code> property set to
true:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> Users <span style=color:#f92672>=</span> Model:extend(<span style=color:#e6db74>&#34;users&#34;</span>, {
</span></span><span style=display:flex><span>  timestamp <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>class Users extends Model
  @timestamp: true
</code></pre><p>Whenever <code>create</code> and <code>update</code> are called the appropriate timestamp column will
also be set.</p><p>You can disable the timestamp from being updated on an <code>update</code> by passing a
final table argument setting <code>timestamp: false</code><code>timestamp = false</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> Users <span style=color:#f92672>=</span> Model:extend(<span style=color:#e6db74>&#34;users&#34;</span>, {
</span></span><span style=display:flex><span>  timestamp <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> user <span style=color:#f92672>=</span> Users:find(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- first form</span>
</span></span><span style=display:flex><span>user:update({ name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello world&#34;</span> }, { timestamp <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span> })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- second form</span>
</span></span><span style=display:flex><span>user.name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello world&#34;</span>
</span></span><span style=display:flex><span>user.age <span style=color:#f92672>=</span> <span style=color:#ae81ff>123</span>
</span></span><span style=display:flex><span>user:update(<span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#e6db74>&#34;age&#34;</span>, { timestamp <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>})
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>class Users extends Model
  @timestamp: true

user = Users\find 1

-- first form
user\update { name: &#34;hello world&#34; }, { timestamp: false }

-- second form
user.name = &#34;hello world&#34;
user.age = 123
user\update &#34;name&#34;, &#34;age&#34;, timestamp: false
</code></pre><h3 id=preloading-associations>Preloading Associations<a href=#preloading-associations class=hanchor arialabel=Anchor>&#8983;</a></h3><p>A common pitfall when using active record type systems is triggering many
queries inside of a loop. In order to avoid situations like this you should
load data for as many objects as possible in a single query before looping over
the data.</p><p>We&rsquo;ll need some models to demonstrate: (The columns are annotated in a comment
above the model).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> Model <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;lapis.db.model&#34;</span>).Model
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- table with columns: id, name</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> Users <span style=color:#f92672>=</span> Model:extend(<span style=color:#e6db74>&#34;users&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> Posts <span style=color:#f92672>=</span> Model:extend(<span style=color:#e6db74>&#34;posts&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>import Model from require &#34;lapis.db.model&#34;

-- table with columns: id, name
class Users extends Model

-- table with columns: id, user_id, text_content
class Posts extends Model
</code></pre><p>Given all the posts, we want to find the user for each post. We use the
<code>include_in</code> class method to include instances of that model in the array of
model instances passed to it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> posts <span style=color:#f92672>=</span> Posts:select() <span style=color:#75715e>-- this gets all the posts</span>
</span></span><span style=display:flex><span>Users:include_in(posts, <span style=color:#e6db74>&#34;user_id&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(posts[<span style=color:#ae81ff>1</span>].user.name) <span style=color:#75715e>-- print the fetched data</span>
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>posts = Posts\select! -- this gets all the posts

Users\include_in posts, &#34;user_id&#34;

print posts[1].user.name -- print the fetched data
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;posts&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;users&#34;</span> <span style=color:#66d9ef>where</span> <span style=color:#e6db74>&#34;id&#34;</span> <span style=color:#66d9ef>in</span> (<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>4</span>,<span style=color:#ae81ff>5</span>,<span style=color:#ae81ff>6</span>)
</span></span></code></pre></div><p>Each post instance is mutated to have a <code>user</code> property assigned to it with an
instance of the <code>Users</code> model. The first argument of <code>include_in</code> is the array
table of model instances. The second argument is the column name of the foreign
key found in the array of model instances that maps to the primary key of the
class calling the <code>include_in</code>.</p><p>The name of the inserted property is derived from the name of the foreign key.
In this case, <code>user</code> was derived from the foreign key <code>user_id</code>. If we want to
manually specify the name we can do something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>Users:include_in(posts, <span style=color:#e6db74>&#34;user_id&#34;</span>, { as: <span style=color:#e6db74>&#34;author&#34;</span> })
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>Users\include_in posts, &#34;user_id&#34;, as: &#34;author&#34;
</code></pre><p>Now all the posts will contain a property named <code>author</code> with an instance of
the <code>Users</code> model.</p><p>Sometimes the relationship is flipped. Instead of the list of model instances
having the foreign key column, the model we want to include might have it. This
is common in one-to-one relationships.</p><p>Here&rsquo;s another set of example models:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> Model <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;lapis.db.model&#34;</span>).Model
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- table with columns: id, name</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> Users <span style=color:#f92672>=</span> Model:extend(<span style=color:#e6db74>&#34;users&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- table with columns: user_id, twitter_account, facebook_username</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> UserData <span style=color:#f92672>=</span> Model:extend(<span style=color:#e6db74>&#34;user_data&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>import Model from require &#34;lapis.db.model&#34;

-- columns: id, name
class Users extends Model

-- columns: user_id, twitter_account, facebook_username
class UserData extends Model
</code></pre><p>Now let&rsquo;s say we have a collection of users and we want to fetch the associated
user data:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> users <span style=color:#f92672>=</span> Users:select()
</span></span><span style=display:flex><span>UserData:include_in(users, <span style=color:#e6db74>&#34;user_id&#34;</span>, { flip: <span style=color:#66d9ef>true</span> })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(users[<span style=color:#ae81ff>1</span>].user_data.twitter_account)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>users = Users\select!
UserData\include_in users, &#34;user_id&#34;, flip: true

print users[1].user_data.twitter_account
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;user_data&#34;</span> <span style=color:#66d9ef>where</span> <span style=color:#e6db74>&#34;user_id&#34;</span> <span style=color:#66d9ef>in</span> (<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>4</span>,<span style=color:#ae81ff>5</span>,<span style=color:#ae81ff>6</span>)
</span></span></code></pre></div><p>In this example we set the <code>flip</code> option to true in the <code>include_in</code> method.
This causes the search to happen against our foreign key, and the ids to be
pulled from the <code>id</code> of the array of model instances.</p><p>Additionally, the derived property name that is injected into the model
instances is created from the name of the included table. In the example above
the <code>user_data</code> property contains the included model instances. (Had it been
plural the table name would have been made singular)</p><h3 id=constraints>Constraints<a href=#constraints class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Often before we insert or update a row we want to check that some conditions
are met. In Lapis these are called constraints. For example let&rsquo;s say we have a
user model and users are not allowed to have the name &ldquo;admin&rdquo;.</p><p>We might define it like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> Model <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;lapis.db.model&#34;</span>).Model
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> Users <span style=color:#f92672>=</span> Model:extend(<span style=color:#e6db74>&#34;users&#34;</span>, {
</span></span><span style=display:flex><span>  constraints <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(self, value)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> value:lower() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;admin&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;User can not be named admin&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>assert(Users:create({
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Admin&#34;</span>
</span></span><span style=display:flex><span>}))
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>import Model from require &#34;lapis.db.models&#34;

class Users extends Model
  @constraints: {
    name: (value) =&gt;
      if value\lower! == &#34;admin&#34;
        &#34;User can not be named admin&#34;
  }


assert Users\create {
  name: &#34;Admin&#34;
}
</code></pre><p>The <code>@constraints</code> class variable<code>constraints</code> property is a table that maps column name to a
function that should check if the constraint is broken. If anything truthy is
returned from the function then the update/insert fails, and that is returned
as the error message.</p><p>In the example above, the call to <code>assert</code> will fail with the error <code>"User can not be named admin"</code>.</p><p>The constraint check function is passed 4 arguments. The model class, the value
of the column being checked, the name of the column being checked, and lastly
the object being checked. On insertion the object is the table passed to the
create method. On update the object is the instance of the model.</p><h3 id=pagination>Pagination<a href=#pagination class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Using the <code>paginated</code> method on models we can easily paginate through a query
that might otherwise return many results. The arguments are the same as the
<code>select</code> method but instead of the result it returns a special <code>Paginator</code>
object.</p><p>For example, say we have the following table and model: (For documentation on
creating tables see the <a href=#database-schemas-creating-and-dropping-tables>next section</a>)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>create_table(<span style=color:#e6db74>&#34;users&#34;</span>, {
</span></span><span style=display:flex><span>  { <span style=color:#e6db74>&#34;id&#34;</span>, types.serial },
</span></span><span style=display:flex><span>  { <span style=color:#e6db74>&#34;name&#34;</span>, types.varchar },
</span></span><span style=display:flex><span>  { <span style=color:#e6db74>&#34;group_id&#34;</span>, types.foreign_key },
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;PRIMARY KEY(id)&#34;</span>
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> Users <span style=color:#f92672>=</span> Model:extend(<span style=color:#e6db74>&#34;users&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>create_table &#34;users&#34;, {
  { &#34;id&#34;, types.serial }
  { &#34;name&#34;, types.varchar }
  { &#34;group_id&#34;, types.foreign_key }

  &#34;PRIMARY KEY(id)&#34;
}

class Users extends Model
</code></pre><p>We can create a paginator like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> paginated <span style=color:#f92672>=</span> Users:paginated(<span style=color:#e6db74>&#34;where group_id = ? order by name asc&#34;</span>, <span style=color:#ae81ff>123</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>paginated = Users\paginated [[where group_id = ? order by name asc]], 123
</code></pre><p>A paginator can be configured by passing a table as the last argument.
The following options are supported:</p><p><code>per_page</code>: sets the number of items per page</p><pre tabindex=0><code class=language-moon data-lang=moon>local paginated_alt = Users:paginated(&#34;where group_id = ?&#34;, 4, { per_page = 100 })
</code></pre><pre tabindex=0><code class=language-moon data-lang=moon>paginated_alt = Users\paginated [[where group_id = ?]], 4, per_page: 100
</code></pre><p><code>prepare_results</code>: a function that is passed the results of <code>get_page</code> and
<code>get_all</code> for processing before they are returned. This is useful for bundling
preloading information into the paginator. The prepare function takes 1
argument, the results, and it must return the results after they have been
processed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> preloaded <span style=color:#f92672>=</span> Posts:paginated(<span style=color:#e6db74>&#34;where category = ?&#34;</span>, <span style=color:#e6db74>&#34;cats&#34;</span>, {
</span></span><span style=display:flex><span>  per_page <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>  prepare_results <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(posts)
</span></span><span style=display:flex><span>    Users:include_in(posts, <span style=color:#e6db74>&#34;user_id&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> posts
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>preloaded = Posts\paginated [[where category = ?]], &#34;cats&#34;, {
  per_page: 10
  prepare_results: (posts) -&gt;
    Users\include_in posts, &#34;user_id&#34;
    posts
}
</code></pre><p>Any additional options sent to <code>paginated</code> are passed directly to the
underlying <code>select</code> method call when a page is loaded. For example you can
provide a <code>fields</code> option in order to limit the fields returned by a page.</p><p>The paginator has the following methods:</p><h4 id=get_all><code>get_all()</code><a href=#get_all class=hanchor arialabel=Anchor>&#8983;</a></h4><p>Gets all the items that the query can return, is the same as calling the
<code>select</code> method directly. Returns an array table of model instances.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> users <span style=color:#f92672>=</span> paginated:get_all()
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>users = paginated\get_all!
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;users&#34;</span> <span style=color:#66d9ef>where</span> group_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>123</span> <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> name <span style=color:#66d9ef>asc</span>
</span></span></code></pre></div><h4 id=get_pagepage_num><code>get_page(page_num)</code><a href=#get_pagepage_num class=hanchor arialabel=Anchor>&#8983;</a></h4><p>Gets <code>page_num</code>th page, where pages are 1 indexed. The number of items per page
is controlled by the <code>per_page</code> option, and defaults to 10. Returns an array
table of model instances.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> page1 <span style=color:#f92672>=</span> paginated:get_page(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> page6 <span style=color:#f92672>=</span> paginated:get_page(<span style=color:#ae81ff>6</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>page1 = paginated\get_page 1
page6 = paginated\get_page 6
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;users&#34;</span> <span style=color:#66d9ef>where</span> group_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>123</span> <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> name <span style=color:#66d9ef>asc</span> <span style=color:#66d9ef>limit</span> <span style=color:#ae81ff>10</span> <span style=color:#66d9ef>offset</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;users&#34;</span> <span style=color:#66d9ef>where</span> group_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>123</span> <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> name <span style=color:#66d9ef>asc</span> <span style=color:#66d9ef>limit</span> <span style=color:#ae81ff>10</span> <span style=color:#66d9ef>offset</span> <span style=color:#ae81ff>50</span>
</span></span></code></pre></div><h4 id=num_pages><code>num_pages()</code><a href=#num_pages class=hanchor arialabel=Anchor>&#8983;</a></h4><p>Returns the total number of pages.</p><h4 id=total_items><code>total_items()</code><a href=#total_items class=hanchor arialabel=Anchor>&#8983;</a></h4><p>Gets the total number of items that can be returned. The paginator will parse
the query and remove all clauses except for the <code>WHERE</code> when issuing a <code>COUNT</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> users <span style=color:#f92672>=</span> paginated:total_items()
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>users = paginated\total_items!
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>COUNT</span>(<span style=color:#f92672>*</span>) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>c</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;users&#34;</span> <span style=color:#66d9ef>where</span> group_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>123</span>
</span></span></code></pre></div><h4 id=each_pagestarting_page1><code>each_page(starting_page=1)</code><a href=#each_pagestarting_page1 class=hanchor arialabel=Anchor>&#8983;</a></h4><p>Returns an iterator function that can be used to iterate through each page of
the results. Useful for processing a large query without having the entire
result set loaded in memory at once.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>for</span> page_results, page_num <span style=color:#66d9ef>in</span> paginated:each_page() <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  print(page_results, page_num)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>for page_results, page_num in paginated\each_page!
  print(page_results, page_num)
</code></pre><h3 id=finding-columns>Finding Columns<a href=#finding-columns class=hanchor arialabel=Anchor>&#8983;</a></h3><p>You can get the column names and column types of a table using the <code>columns</code>
method on the model class:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> Posts <span style=color:#f92672>=</span> Model:extend(<span style=color:#e6db74>&#34;posts&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> _, col <span style=color:#66d9ef>in</span> ipairs(Posts:columns) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  print(col.column_name, col.data_type)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>class Posts extends Model

for {column_name, data_type} in Posts\columns!
  print column_name, data_type
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>column_name</span>, data_type
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FROM</span> information_schema.columns <span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>table_name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;posts&#39;</span>
</span></span></code></pre></div><h3 id=refreshing-a-model-instance>Refreshing a Model Instance<a href=#refreshing-a-model-instance class=hanchor arialabel=Anchor>&#8983;</a></h3><p>If your model instance becomes out of date from an external change, it can tell
it to re-fetch and re-populate it&rsquo;s data using the <code>refresh</code> method.</p><pre tabindex=0><code class=language-moon data-lang=moon>class Posts extends Model
post = Posts\find 1
post\refresh!
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> Posts <span style=color:#f92672>=</span> Model:extend(<span style=color:#e6db74>&#34;posts&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> post <span style=color:#f92672>=</span> Posts:find(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>post:refresh()
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;posts&#34;</span> <span style=color:#66d9ef>where</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>By default all fields are refreshed. If you only want to refresh specific fields
then pass them in as arguments:</p><pre tabindex=0><code class=language-moon data-lang=moon>class Posts extends Model
post = Posts\find 1
post\refresh &#34;color&#34;, &#34;height&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> Posts <span style=color:#f92672>=</span> Model:extend(<span style=color:#e6db74>&#34;posts&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> post <span style=color:#f92672>=</span> Posts:find(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>post:refresh(<span style=color:#e6db74>&#34;color&#34;</span>, <span style=color:#e6db74>&#34;height&#34;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#34;color&#34;</span>, <span style=color:#e6db74>&#34;height&#34;</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;posts&#34;</span> <span style=color:#66d9ef>where</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><h2 id=database-schemas>Database Schemas<a href=#database-schemas class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Lapis comes with a collection of tools for creating your database schema inside
of the <code>lapis.db.schema</code> module.</p><h3 id=creating-and-dropping-tables>Creating and Dropping Tables<a href=#creating-and-dropping-tables class=hanchor arialabel=Anchor>&#8983;</a></h3><h4 id=create_tabletable_name--table_declarations-><code>create_table(table_name, { table_declarations... })</code><a href=#create_tabletable_name--table_declarations- class=hanchor arialabel=Anchor>&#8983;</a></h4><p>The first argument to <code>create_table</code> is the name of the table and the second
argument is an array table that describes the table.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> schema <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;lapis.db.schema&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> types <span style=color:#f92672>=</span> schema.types
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>schema.create_table(<span style=color:#e6db74>&#34;users&#34;</span>, {
</span></span><span style=display:flex><span>  {<span style=color:#e6db74>&#34;id&#34;</span>, types.serial},
</span></span><span style=display:flex><span>  {<span style=color:#e6db74>&#34;username&#34;</span>, types.varchar},
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;PRIMARY KEY (id)&#34;</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>schema = require &#34;lapis.db.schema&#34;

import create_table, types from schema

create_table &#34;users&#34;, {
  {&#34;id&#34;, types.serial}
  {&#34;username&#34;, types.varchar}

  &#34;PRIMARY KEY (id)&#34;
}
</code></pre><p>This will generate the following SQL:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#e6db74>&#34;users&#34;</span> (
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;id&#34;</span> serial <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;username&#34;</span> character varying(<span style=color:#ae81ff>255</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (id)
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>The items in the second argument to <code>create_table</code> can either be a table, or a
string. When the value is a table it is treated as a column/type tuple:</p><pre><code>{ column_name, column_type }
</code></pre><p>They are both plain strings. The column name will be escaped automatically.
The column type will be inserted verbatim after it is passed through
<code>tostring</code>. <code>schema.types</code> has a collection of common types that can be used.
For example, <code>schema.types.varchar</code> evaluates to <code>character varying(255) NOT NULL</code>. See more about types below.</p><p>If the value to the second argument is a string then it is inserted directly
into the <code>CREATE TABLE</code> statement, that&rsquo;s how we create the primary key above.</p><h4 id=drop_tabletable_name><code>drop_table(table_name)</code><a href=#drop_tabletable_name class=hanchor arialabel=Anchor>&#8983;</a></h4><p>Drops a table.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>schema.drop_table(<span style=color:#e6db74>&#34;users&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>import drop_table from schema

drop_table &#34;users&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#e6db74>&#34;users&#34;</span>;
</span></span></code></pre></div><h3 id=indexes>Indexes<a href=#indexes class=hanchor arialabel=Anchor>&#8983;</a></h3><h4 id=create_indextable_name-col1-col2-options><code>create_index(table_name, col1, col2..., [options])</code><a href=#create_indextable_name-col1-col2-options class=hanchor arialabel=Anchor>&#8983;</a></h4><p><code>create_index</code> is used to add new indexes to a table. The first argument is a
table, the rest of the arguments are the ordered columns that make up the
index. Optionally the last argument can be a Lua table of options.</p><p>There are two options <code>unique: BOOL</code>, <code>where: clause_string</code>.</p><p><code>create_index</code> will also check if the index exists before attempting to create
it. If the index exists then nothing will happen.</p><p>Here are some example indexes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> create_index <span style=color:#f92672>=</span> schema.create_index
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>create_index(<span style=color:#e6db74>&#34;users&#34;</span>, <span style=color:#e6db74>&#34;created_at&#34;</span>)
</span></span><span style=display:flex><span>create_index(<span style=color:#e6db74>&#34;users&#34;</span>, <span style=color:#e6db74>&#34;username&#34;</span>, { unique <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span> })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>create_index(<span style=color:#e6db74>&#34;posts&#34;</span>, <span style=color:#e6db74>&#34;category&#34;</span>, <span style=color:#e6db74>&#34;title&#34;</span>)
</span></span><span style=display:flex><span>create_index(<span style=color:#e6db74>&#34;uploads&#34;</span>, <span style=color:#e6db74>&#34;name&#34;</span>, { where <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;not deleted&#34;</span> })
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>import create_index from schema

create_index &#34;users&#34;, &#34;created_at&#34;
create_index &#34;users&#34;, &#34;username&#34;, unique: true

create_index &#34;posts&#34;, &#34;category&#34;, &#34;title&#34;
create_index &#34;uploads&#34;, &#34;name&#34;, where: &#34;not deleted&#34;
</code></pre><p>This will generate the following SQL:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#66d9ef>ON</span> <span style=color:#e6db74>&#34;users&#34;</span> (created_at);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>UNIQUE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#66d9ef>ON</span> <span style=color:#e6db74>&#34;users&#34;</span> (username);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#66d9ef>ON</span> <span style=color:#e6db74>&#34;posts&#34;</span> (category, title);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#66d9ef>ON</span> <span style=color:#e6db74>&#34;uploads&#34;</span> (name) <span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>not</span> deleted;
</span></span></code></pre></div><h4 id=drop_indextable_name-col1-col2><code>drop_index(table_name, col1, col2...)</code><a href=#drop_indextable_name-col1-col2 class=hanchor arialabel=Anchor>&#8983;</a></h4><p>Drops an index from a table. It calculates the name of the index from the table
name and columns. This is the same as the default index name generated by PostgreSQL.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> drop_index <span style=color:#f92672>=</span> schema.drop_index
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>drop_index(<span style=color:#e6db74>&#34;users&#34;</span>, <span style=color:#e6db74>&#34;created_at&#34;</span>)
</span></span><span style=display:flex><span>drop_index(<span style=color:#e6db74>&#34;posts&#34;</span>, <span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#e6db74>&#34;published&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>import drop_index from schema

drop_index &#34;users&#34;, &#34;created_at&#34;
drop_index &#34;posts&#34;, &#34;title&#34;, &#34;published&#34;
</code></pre><p>This will generate the following SQL:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#e6db74>&#34;users_created_at_idx&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#e6db74>&#34;posts_title_published_idx&#34;</span>
</span></span></code></pre></div><h3 id=altering-tables>Altering Tables<a href=#altering-tables class=hanchor arialabel=Anchor>&#8983;</a></h3><h4 id=add_columntable_name-column_name-column_type><code>add_column(table_name, column_name, column_type)</code><a href=#add_columntable_name-column_name-column_type class=hanchor arialabel=Anchor>&#8983;</a></h4><p>Adds a column to a table.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>schema.add_column(<span style=color:#e6db74>&#34;users&#34;</span>, <span style=color:#e6db74>&#34;age&#34;</span>, types.integer)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>import add_column, types from schema

add_column &#34;users&#34;, &#34;age&#34;, types.integer
</code></pre><p>Generates the SQL:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#e6db74>&#34;users&#34;</span> <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>COLUMN</span> <span style=color:#e6db74>&#34;age&#34;</span> integer <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h4 id=drop_columntable_name-column_name><code>drop_column(table_name, column_name)</code><a href=#drop_columntable_name-column_name class=hanchor arialabel=Anchor>&#8983;</a></h4><p>Removes a column from a table.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>schema.drop_column(<span style=color:#e6db74>&#34;users&#34;</span>, <span style=color:#e6db74>&#34;age&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>import drop_column from schema

drop_column &#34;users&#34;, &#34;age&#34;
</code></pre><p>Generates the SQL:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#e6db74>&#34;users&#34;</span> <span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>COLUMN</span> <span style=color:#e6db74>&#34;age&#34;</span>
</span></span></code></pre></div><h4 id=rename_columntable_name-old_name-new_name><code>rename_column(table_name, old_name, new_name)</code><a href=#rename_columntable_name-old_name-new_name class=hanchor arialabel=Anchor>&#8983;</a></h4><p>Changes the name of a column.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>schema.rename_column(<span style=color:#e6db74>&#34;users&#34;</span>, <span style=color:#e6db74>&#34;age&#34;</span>, <span style=color:#e6db74>&#34;lifespan&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>import rename_column from schema

rename_column &#34;users&#34;, &#34;age&#34;, &#34;lifespan&#34;
</code></pre><p>Generates the SQL:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#e6db74>&#34;users&#34;</span> <span style=color:#66d9ef>RENAME</span> <span style=color:#66d9ef>COLUMN</span> <span style=color:#e6db74>&#34;age&#34;</span> <span style=color:#66d9ef>TO</span> <span style=color:#e6db74>&#34;lifespan&#34;</span>
</span></span></code></pre></div><h4 id=rename_tableold_name-new_name><code>rename_table(old_name, new_name)</code><a href=#rename_tableold_name-new_name class=hanchor arialabel=Anchor>&#8983;</a></h4><p>Changes the name of a table.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>schema.rename_table(<span style=color:#e6db74>&#34;users&#34;</span>, <span style=color:#e6db74>&#34;members&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>import rename_table from schema

rename_table &#34;users&#34;, &#34;members&#34;
</code></pre><p>Generates the SQL:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#e6db74>&#34;users&#34;</span> <span style=color:#66d9ef>RENAME</span> <span style=color:#66d9ef>TO</span> <span style=color:#e6db74>&#34;members&#34;</span>
</span></span></code></pre></div><h3 id=column-types>Column Types<a href=#column-types class=hanchor arialabel=Anchor>&#8983;</a></h3><p>All of the column type generators are stored in <code>schema.types</code>. All the types
are special objects that can either be turned into a type declaration string
with <code>tostring</code>, or called like a function to be customized.</p><p>Here are all the default values:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> types <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;lapis.db.schema&#34;</span>).types
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>types.boolean       <span style=color:#75715e>--&gt; boolean NOT NULL DEFAULT FALSE</span>
</span></span><span style=display:flex><span>types.date          <span style=color:#75715e>--&gt; date NOT NULL</span>
</span></span><span style=display:flex><span>types.double        <span style=color:#75715e>--&gt; double precision NOT NULL DEFAULT 0</span>
</span></span><span style=display:flex><span>types.foreign_key   <span style=color:#75715e>--&gt; integer NOT NULL</span>
</span></span><span style=display:flex><span>types.integer       <span style=color:#75715e>--&gt; integer NOT NULL DEFAULT 0</span>
</span></span><span style=display:flex><span>types.numeric       <span style=color:#75715e>--&gt; numeric NOT NULL DEFAULT 0</span>
</span></span><span style=display:flex><span>types.real          <span style=color:#75715e>--&gt; real NOT NULL DEFAULT 0</span>
</span></span><span style=display:flex><span>types.serial        <span style=color:#75715e>--&gt; serial NOT NULL</span>
</span></span><span style=display:flex><span>types.text          <span style=color:#75715e>--&gt; text NOT NULL</span>
</span></span><span style=display:flex><span>types.time          <span style=color:#75715e>--&gt; timestamp without time zone NOT NULL</span>
</span></span><span style=display:flex><span>types.varchar       <span style=color:#75715e>--&gt; character varying(255) NOT NULL</span>
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>import types from require &#34;lapis.db.schema&#34;

types.boolean       --&gt; boolean NOT NULL DEFAULT FALSE
types.date          --&gt; date NOT NULL
types.double        --&gt; double precision NOT NULL DEFAULT 0
types.foreign_key   --&gt; integer NOT NULL
types.integer       --&gt; integer NOT NULL DEFAULT 0
types.numeric       --&gt; numeric NOT NULL DEFAULT 0
types.real          --&gt; real NOT NULL DEFAULT 0
types.serial        --&gt; serial NOT NULL
types.text          --&gt; text NOT NULL
types.time          --&gt; timestamp without time zone NOT NULL
types.varchar       --&gt; character varying(255) NOT NULL
</code></pre><p>You&rsquo;ll notice everything is <code>NOT NULL</code> by default, and the numeric types have
defaults of 0 and boolean false.</p><p>When a type is called like a function it takes one argument, a table of
options. The options include:</p><ul><li><code>default: value</code> &ndash; sets default value</li><li><code>null: boolean</code> &ndash; determines if the column is <code>NOT NULL</code></li><li><code>unique: boolean</code> &ndash; determines if the column has a unique index</li><li><code>primary_key: boolean</code> &ndash; determines if the column is the primary key</li></ul><p>Here are some examples:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>types.integer({ default <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>, null <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span> })  <span style=color:#75715e>--&gt; integer DEFAULT 1</span>
</span></span><span style=display:flex><span>types.integer({ primary_key <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span> })        <span style=color:#75715e>--&gt; integer NOT NULL DEFAULT 0 PRIMARY KEY</span>
</span></span><span style=display:flex><span>types.text({ null <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span> })                  <span style=color:#75715e>--&gt; text</span>
</span></span><span style=display:flex><span>types.varchar({ primary_key <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span> })        <span style=color:#75715e>--&gt; character varying(255) NOT NULL PRIMARY KEY</span>
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>types.integer default: 1, null: true  --&gt; integer DEFAULT 1
types.integer primary_key: true       --&gt; integer NOT NULL DEFAULT 0 PRIMARY KEY
types.text null: true                 --&gt; text
types.varchar primary_key: true       --&gt; character varying(255) NOT NULL PRIMARY KEY
</code></pre><h2 id=database-migrations>Database Migrations<a href=#database-migrations class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Because requirements typically change over the lifespan of a web application
it&rsquo;s useful to have a system to make incremental schema changes to the
database.</p><p>We define migrations in our code as a table of functions where the key of each
function in the table is the name of the migration. You are free to name the
migrations anything but it&rsquo;s suggested to give them Unix timestamps as names:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> schema <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;lapis.db.schema&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>  [<span style=color:#ae81ff>1368686109</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>    schema.add_column(<span style=color:#e6db74>&#34;my_table&#34;</span>, <span style=color:#e6db74>&#34;hello&#34;</span>, schema.types.integer)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  [<span style=color:#ae81ff>1368686843</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>    schema.create_index(<span style=color:#e6db74>&#34;my_table&#34;</span>, <span style=color:#e6db74>&#34;hello&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>import add_column, create_index, types from require &#34;lapis.db.schema&#34;

{
  [1368686109]: =&gt;
    add_column &#34;my_table&#34;, &#34;hello&#34;, types.integer

  [1368686843]: =&gt;
    create_index &#34;my_table&#34;, &#34;hello&#34;
}
</code></pre><p>A migration function is a plain function. Generally they will call the
schema functions described above, but they don&rsquo;t have to.</p><p>Only the functions that haven&rsquo;t already been executed will be called when we
tell our migrations to run. The migrations that have already been run are
stored in the migrations table, a database table that holds the names of the
migrations that have already been run. Migrations are run in the order of their
keys sorted ascending.</p><h3 id=running-migrations>Running Migrations<a href=#running-migrations class=hanchor arialabel=Anchor>&#8983;</a></h3><p>The Lapis command line tool has a special command for running migrations. It&rsquo;s
called <code>lapis migrate</code>.</p><p>This command expects a module called <code>migrations</code> that returns a table of
migrations in the format described above.</p><p>Let&rsquo;s create this file with a single migration as an example.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- migrations.lua</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> schema <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;lapis.db.schema&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> types <span style=color:#f92672>=</span> schema.types
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>  [<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>    schema.create_table(<span style=color:#e6db74>&#34;articles&#34;</span>, {
</span></span><span style=display:flex><span>      { <span style=color:#e6db74>&#34;id&#34;</span>, types.serial },
</span></span><span style=display:flex><span>      { <span style=color:#e6db74>&#34;title&#34;</span>, types.text },
</span></span><span style=display:flex><span>      { <span style=color:#e6db74>&#34;content&#34;</span>, types.text },
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;PRIMARY KEY (id)&#34;</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>-- migrations.moon

import create_table, types from require &#34;lapis.db.schema&#34;

{
  [1]: =&gt;
    create_table &#34;articles&#34;, {
      { &#34;id&#34;, types.serial }
      { &#34;title&#34;, types.text }
      { &#34;content&#34;, types.text }

      &#34;PRIMARY KEY (id)&#34;
    }
}
</code></pre><p>After creating the file, ensure that it is compiled to Lua and run <code>lapis migrate</code>. The command will first create the migrations table if it doesn&rsquo;t
exist yet then it will run every migration that hasn&rsquo;t been executed yet.</p><p>Read more about <a href=#command-line-interface-lapis-migrate>the migrate command</a>.</p><h3 id=manually-running-migrations>Manually Running Migrations<a href=#manually-running-migrations class=hanchor arialabel=Anchor>&#8983;</a></h3><p>We can manually create the migrations table using the following code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> migrations <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;lapis.db.migrations&#34;</span>)
</span></span><span style=display:flex><span>migrations.create_migrations_table()
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>migrations = require &#34;lapis.db.migrations&#34;
migrations.create_migrations_table!
</code></pre><p>It will execute the following SQL:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#e6db74>&#34;lapis_migrations&#34;</span> (
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;name&#34;</span> character varying(<span style=color:#ae81ff>255</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>(name)
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>Then we can manually run migrations with the following code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> migrations <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;lapis.db.migrations&#34;</span>)
</span></span><span style=display:flex><span>migrations.run_migrations(require(<span style=color:#e6db74>&#34;migrations&#34;</span>))
</span></span></code></pre></div><pre tabindex=0><code class=language-moon data-lang=moon>import run_migrations from require &#34;lapis.db.migrations&#34;
run_migrations require &#34;migrations&#34;
</code></pre><h1 id=html-generation>HTML Generation<a href=#html-generation class=hanchor arialabel=Anchor>&#8983;</a></h1><p>This guide is focused on using builder syntax in Lua/MoonScript to generate
HTML. If you&rsquo;re interested in a more traditional templating system see the
<a href=$root/reference/etlua_templates.html>etlua Templates guide</a>.</p><h2 id=html-in-actions>HTML In Actions<a href=#html-in-actions class=hanchor arialabel=Anchor>&#8983;</a></h2><p>If we want to generate HTML directly in our action we can use the <code>@html</code>
method:</p><pre tabindex=0><code class=language-moon data-lang=moon>&#34;/&#34;: =&gt;
  @html -&gt;
    h1 class: &#34;header&#34;, &#34;Hello&#34;
    div class: &#34;body&#34;, -&gt;
      text &#34;Welcome to my site!&#34;
</code></pre><p>HTML templates can be written directly as MoonScript (or Lua) code. This is a
very powerful feature (inspired by <a href=http://erector.rubyforge.org/>Erector</a>)
that gives us the ability to write templates with high composability and also
all the features of MoonScript. No need to learn any goofy templating syntax
with arbitrary restrictions.</p><p>The <code>@html</code> method overrides the environment of the function passed to it.
Functions that create HTML tags are generated on the fly as you call them. The
output of these functions is written into a buffer that is compiled in the end
and returned as the result of the action.</p><p>Here are some examples of the HTML generation:</p><pre tabindex=0><code class=language-moon data-lang=moon>div!                -- &lt;div&gt;&lt;/div&gt;
b &#34;Hello World&#34;     -- &lt;b&gt;Hello World&lt;/b&gt;
div &#34;hi&lt;br/&gt;&#34;       -- &lt;div&gt;hi&amp;lt;br/&amp;gt;&lt;/div&gt;
text &#34;Hi!&#34;          -- Hi!
raw &#34;&lt;br/&gt;&#34;         -- &lt;br/&gt;

element &#34;table&#34;, width: &#34;100%&#34;, -&gt;  -- &lt;table width=&#34;100%&#34;&gt;&lt;/table&gt;

div class: &#34;footer&#34;, &#34;The Foot&#34;     -- &lt;div class=&#34;footer&#34;&gt;The Foot&lt;/div&gt;

div -&gt;                              -- &lt;div&gt;Hey&lt;/div&gt;
  text &#34;Hey&#34;

div class: &#34;header&#34;, -&gt;             -- &lt;div class=&#34;header&#34;&gt;&lt;h2&gt;My Site&lt;/h2&gt;
  h2 &#34;My Site&#34;                      --    &lt;p&gt;Welcome!&lt;/p&gt;&lt;/div&gt;
  p &#34;Welcome!&#34;
</code></pre><p>The <code>element</code> function is a special builder that takes the name of tag to
generate as the first argument followed by any attributes and content.</p><p>The HTML builder methods have lower precedence than any existing variables, so
if you have a variable named <code>div</code> and you want to make a <code>&lt;div></code> tag you&rsquo;ll need
to call <code>element "div"</code>.</p><blockquote><p>If you want to create a <code>&lt;table></code> or <code>&lt;select></code> tag you&rsquo;ll need to use <code>element</code> because Lua
uses those names in the built-in modules.</p></blockquote><h2 id=html-widgets>HTML Widgets<a href=#html-widgets class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The preferred way to write HTML is through widgets. Widgets are classes who are
only concerned with outputting HTML. They use the same syntax as the <code>@html</code>
helper shown above for writing HTML.</p><p>When Lapis loads a widget automatically it does it by package name. For
example, if it was loading the widget for the name <code>"index"</code> it would try to
load the module <code>views.index</code>, and the result of that module should be the
widget.</p><p>This is what a widget looks like:</p><pre tabindex=0><code class=language-moon data-lang=moon>-- views/index.moon
import Widget from require &#34;lapis.html&#34;

class Index extends Widget
  content: =&gt;
    h1 class: &#34;header&#34;, &#34;Hello&#34;
    div class: &#34;body&#34;, -&gt;
      text &#34;Welcome to my site!&#34;
</code></pre><blockquote><p>The name of the widget class is insignificant, but it&rsquo;s worth making one
because some systems can auto-generate encapsulating HTML named after the
class.</p></blockquote><h3 id=rendering-a-widget-from-an-action>Rendering A Widget From An Action<a href=#rendering-a-widget-from-an-action class=hanchor arialabel=Anchor>&#8983;</a></h3><p>The <code>render</code> option key is used to render a widget. For example you can render
the <code>"index"</code> widget from our action by returning a table with render set to
the name of the widget:</p><pre tabindex=0><code class=language-moon data-lang=moon>&#34;/&#34;: =&gt;
  render: &#34;index&#34;
</code></pre><p>If the action has a name, then we can set render to <code>true</code> to load the widget
with the same name as the action:</p><pre tabindex=0><code class=language-moon data-lang=moon>[index: &#34;/&#34;]: =&gt;
  render: true
</code></pre><p>By default <code>views.</code> is appended to the front of the widget name and then loaded
using Lua&rsquo;s <code>require</code> function. The <code>views</code> prefix can be customized by
overwriting the <code>views_prefix</code> member of your application subclass:</p><pre tabindex=0><code class=language-moon data-lang=moon>class Application extends lapis.Application
  views_prefix: &#34;app_views&#34;

  -- will use &#34;app_views.home&#34; as the view
  [home: &#34;/home&#34;]: =&gt; render: true
</code></pre><h3 id=passing-data-to-a-widget>Passing Data To A Widget<a href=#passing-data-to-a-widget class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Any <code>@</code> variables set in the action can be accessed in the widget. Additionally
any of the helper functions like <code>@url_for</code> are also accessible.</p><pre tabindex=0><code class=language-moon data-lang=moon>-- web.moon
[index: &#34;/&#34;]: =&gt;
  @page_title = &#34;Welcome To My Page&#34;
  render: true
</code></pre><pre tabindex=0><code class=language-moon data-lang=moon>-- views/index.moon
import Widget from require &#34;lapis.html&#34;

class Index extends Widget
  content: =&gt;
    h1 class: &#34;header&#34;, @page_title
    div class: &#34;body&#34;, -&gt;
      text &#34;Welcome to my site!&#34;
</code></pre><h3 id=rendering-widgets-manually>Rendering Widgets Manually<a href=#rendering-widgets-manually class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Widgets can also be rendered manually by instantiating them and calling the
<code>render</code> method.</p><pre tabindex=0><code class=language-moon data-lang=moon>Index = require &#34;views.index&#34;

widget = Index page_title: &#34;Hello World&#34;
print widget\render_to_string!
</code></pre><p>If you want to use helpers like <code>@url_for</code> you also need to include them in the
widget instance. Any object can be included as a helper, and it&rsquo;s methods will
be made available inside of the widget.</p><pre tabindex=0><code class=language-moon data-lang=moon>html = require &#34;lapis.html&#34;
class SomeWidget extends html.Widget
  content: =&gt;
    a href: @url_for(&#34;test&#34;), &#34;Test Page&#34;

class extends lapis.Application
  [test: &#34;/test_render&#34;]: =&gt;
    widget = SomeWidget!
    widget\include_helper @
    widget\render_to_string!
</code></pre><p>You should avoid rendering widgets manually when possible. When in an action
use the <code>render</code> <a href=#request-object-request-options>request option</a>. When in
another widget use the <code>widget</code> helper function.</p><h2 id=layouts>Layouts<a href=#layouts class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Whenever an action is rendered normally the result is inserted into the
current layout. The layout is just another widget, but it is used across many
pages. Typically this is where you would put your <code>&lt;html></code> and <code>&lt;head></code> tags.</p><p>Lapis comes with a default layout that looks like this:</p><pre tabindex=0><code class=language-moon data-lang=moon>html = require &#34;lapis.html&#34;

class DefaultLayout extends html.Widget
  content: =&gt;
    html_5 -&gt;
      head -&gt; title @title or &#34;Lapis Page&#34;
      body -&gt; @content_for &#34;inner&#34;
</code></pre><p>Use this as a starting point for creating your own layout. The content of your
page will be injected in the location of the call to <code>@content_for "inner"</code>.</p><p>We can specify the layout for an entire application or specify it for a
specific action. For example, if we have our new layout in <code>views/my_layout.moon</code></p><pre tabindex=0><code class=language-moon data-lang=moon>class extends lapis.Application
  layout: require &#34;views.my_layout&#34;
</code></pre><p>If we want to set the layout for a specific action we can provide it as part of
the action&rsquo;s return value.</p><pre tabindex=0><code class=language-moon data-lang=moon>class extends lapis.Application
  -- the following two have the same effect
  &#34;/home1&#34;: =&gt;
    layout: &#34;my_layout&#34;

  &#34;/home2&#34;: =&gt;
    layout: require &#34;views.my_layout&#34;

  -- this doesn&#39;t use a layout at all
  &#34;/no_layout&#34;: =&gt;
    layout: false, &#34;No layout rendered!&#34;
</code></pre><p>As demonstrated in the example, passing false will prevent any layout from
being rendered.</p><h2 id=widget-methods>Widget Methods<a href=#widget-methods class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=includeother_class><code>@@include(other_class)</code><a href=#includeother_class class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Class method that copies the methods from another class into this widget.
Useful for mixin in shared functionality across multiple widgets.</p><pre tabindex=0><code class=language-moon data-lang=moon>class MyHelpers
  item_list: (items) =&gt;
    ul -&gt;
      for item in *items
        li item


class SomeWidget extends html.Widget
  @include MyHelpers

  content: =&gt;
    @item_list {&#34;hello&#34;, &#34;world&#34;}
</code></pre><h3 id=content_forname-content><code>@content_for(name, [content])</code><a href=#content_forname-content class=hanchor arialabel=Anchor>&#8983;</a></h3><p><code>content_for</code> is used for sending HTML or strings from the view to the layout.
You&rsquo;ve probably already seen <code>@content_for "inner"</code> if you&rsquo;ve looked at
layouts. By default the content of the view is placed in the content block
called <code>"inner"</code>.</p><p>You can create arbitrary content blocks from the view by calling <code>@content_for</code>
with a name and some content:</p><pre tabindex=0><code class=language-moon data-lang=moon>class MyView extends Widget
  content: =&gt;
    @content_for &#34;title&#34;, &#34;This is the title of my page!&#34;

    @content_for &#34;footer&#34;, -&gt;
      div class: &#34;custom_footer&#34;, &#34;The Footer&#34;
</code></pre><p>You can use either strings or builder functions as the content.</p><p>To access the content from the layout call <code>@content_for</code> without the content
argument:</p><pre tabindex=0><code class=language-moon data-lang=moon>class MyLayout extends Widget
  content: =&gt;
    html -&gt;
      body -&gt;
        div class: &#34;title&#34;, -&gt;
          @content_for &#34;title&#34;

        @content_for &#34;inner&#34;
        @content_for &#34;footer&#34;
</code></pre><p>If a string is used as the value of a content block then it will be escaped
before written to the buffer. If you want to insert a raw string then you can
use a builder function in conjunction with the <code>raw</code> function:</p><pre tabindex=0><code class=language-moon data-lang=moon>@content_for &#34;footer&#34;, -&gt;
  raw &#34;&lt;pre&gt;this wont&#39; be escaped&lt;/pre&gt;&#34;
</code></pre><h3 id=has_content_forname><code>@has_content_for(name)</code><a href=#has_content_forname class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Checks to see if content for <code>name</code> is set.</p><pre tabindex=0><code class=language-moon data-lang=moon>class MyView extends Widget
  content: =&gt;
    if @has_content_for &#34;things&#34;
      @content_for &#34;things&#34;
    else
      div -&gt;
        text &#34;default content&#34;
</code></pre><h2 id=html-module>HTML Module<a href=#html-module class=hanchor arialabel=Anchor>&#8983;</a></h2><pre tabindex=0><code class=language-moon data-lang=moon>html = require &#34;lapis.html&#34;
</code></pre><h3 id=render_htmlfn><code>render_html(fn)</code><a href=#render_htmlfn class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Runs the function, <code>fn</code> in the HTML rendering context as described above.
Returns the resulting HTML. The HTML context will automatically convert any
reference to an undefined global variable into a function that will render the
appropriate tag.</p><pre tabindex=0><code class=language-moon data-lang=moon>import render_html from require &#34;lapis.html&#34;

print render_html -&gt;
  div class: &#34;item&#34;, -&gt;
    strong &#34;Hello!&#34;
</code></pre><h3 id=escapestr><code>escape(str)</code><a href=#escapestr class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Escapes any HTML special characters in the string. The following are escaped:</p><ul><li><code>&</code> &ndash; <code>&amp;amp;</code></li><li><code>&lt;</code> &ndash; <code>&amp;lt;</code></li><li><code>></code> &ndash; <code>&amp;gt;</code></li><li><code>"</code> &ndash; <code>&amp;quot;</code></li><li><code>'</code> &ndash; <code>&amp;#039;</code></li></ul></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/misc/lapis_console/><span class=button__icon>←</span>
<span class=button__text>lapis_console.md</span></a></span>
<span class="button next"><a href=/posts/misc/loving-ssh/><span class=button__text>loving-ssh.md</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>@linuxing3</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script>
<script src=/assets/prism.js></script>
<script src=/assets/languageSelector.js></script></div></body></html>